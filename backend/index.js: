const express = require("express");
const fetch = require("node-fetch");
const app = express();

const CLIENT_ID = "Ov23lieJvl53EqM9PnML"; // Your GitHub OAuth client ID
let deviceData = null;

// Step 1: Request device code
app.get("/device", async (req, res) => {
  const response = await fetch(
    "https://github.com/login/device/code",
    {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        client_id: CLIENT_ID,
        scope: "repo"
      })
    }
  );

  const data = await response.json();
  deviceData = data;

  res.json({
    message: "Go to the URL and enter the code",
    user_code: data.user_code,
    verification_url: data.verification_uri
  });
});

// Step 2: Poll for token
app.get("/poll", async (req, res) => {
  if (!deviceData) return res.json({ error: "No device login started" });

  const response = await fetch(
    "https://github.com/login/oauth/access_token",
    {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        client_id: CLIENT_ID,
        device_code: deviceData.device_code,
        grant_type: "urn:ietf:params:oauth:grant-type:device_code"
      })
    }
  );

  const token = await response.json();
  res.json(token);
});

app.listen(3000, () => {
  console.log("Subnify backend running on port 3000");
});
